<script>
    const socket = new WebSocket("wss://h-heas.onrender.com");
    let alertSound = new Audio("alert.mp3"); // Load alert sound
    const logContainer = document.getElementById("logContainer");
    let soundEnabled = false;
    let firstAlertTriggered = false;

    // Preload and enable sound on user interaction
    document.body.addEventListener("click", () => {
        if (!soundEnabled) {
            alertSound.play().catch(() => console.log("ðŸ”Š Sound enabled after user interaction."));
            alertSound.muted = false;
            soundEnabled = true;
        }
    });

    socket.onopen = () => {
        console.log("Connected to WebSocket as Monitoring Base.");
        socket.send(JSON.stringify({ monitor: true }));
    };

    socket.onmessage = async (event) => {
        try {
            const data = await event.data.text();
            const parsedData = JSON.parse(data);

            if (!parsedData.sender || !parsedData.alert) {
                console.warn("Invalid alert received:", parsedData);
                return;
            }

            console.log("Received Alert:", parsedData);

            if (soundEnabled) {
                if (!firstAlertTriggered) {
                    // âœ… Force play the first alert sound
                    await alertSound.play().catch(err => console.log("ðŸ”Š First alert sound error:", err));
                    firstAlertTriggered = true;
                } else {
                    // âœ… Play normally for subsequent alerts
                    alertSound.pause();
                    alertSound.currentTime = 0;
                    alertSound.play().catch(err => console.log("Error playing sound", err));
                }
            }

            alert(`ðŸš¨ Emergency Alert - ${parsedData.sender} ${parsedData.alert}`);

            const logEntry = document.createElement("div");
            logEntry.classList.add("log-entry");
            logEntry.innerText = `ðŸ•’ ${new Date().toLocaleTimeString()} - ðŸš¨ ${parsedData.sender} ${parsedData.alert}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // âœ… SEND AUTOMATIC REPLY BACK TO SENDER
            const replyMessage = {
                recipient: parsedData.sender, 
                response: "Help is on the way!"
            };
            socket.send(JSON.stringify(replyMessage));
            console.log("âœ… Reply sent:", replyMessage);

        } catch (error) {
            console.error("Error processing WebSocket message:", error);
        }
    };

    socket.onclose = () => console.log("Disconnected from WebSocket.");
</script>

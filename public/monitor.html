<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Base</title>
    <style>
        /* Existing CSS styles */
    </style>
</head>
<body>
    <h2>House to House Emergency Alert System</h2>
    <h2>( H - H E A S )</h2>
    <p>Monitoring Base - Waiting for emergency signals...</p>
    <div id="logContainer"></div>

    <div id="alertModal">
        <p id="alertMessage">üö® Emergency Alert Received!</p>
        <button onclick="closeModal()">OK</button>
    </div>

    <audio id="alertSound" src="alert.mp3"></audio>
    <audio id="falseAlarmSound" src="false_alarm.mp3"></audio>

    <button id="logoutButton" onclick="logout()">Logout</button>

    <script>
        if (sessionStorage.getItem("loggedIn") !== "true") {
            alert("‚ùå Access Denied! Please login first.");
            window.location.href = "login.html";
        }

        const socket = new WebSocket("wss://h-heas.onrender.com");
        const logContainer = document.getElementById("logContainer");
        const alertSound = document.getElementById("alertSound");
        const falseAlarmSound = document.getElementById("falseAlarmSound");
        const alertModal = document.getElementById("alertModal");
        const alertMessage = document.getElementById("alertMessage");

        let currentSender = ""; // To store the sender's information

        socket.onopen = () => {
            console.log("‚úÖ Connected to WebSocket as Monitoring Base.");
        };

        socket.onmessage = async (event) => {
            try {
                const data = await event.data.text();
                const parsedData = JSON.parse(data);

                if (!parsedData.sender || !parsedData.alert) {
                    console.warn("‚ö†Ô∏è Invalid alert received:", parsedData);
                    return;
                }

                console.log("üö® Received Alert:", parsedData);

                currentSender = parsedData.sender; // Store the sender's information

                if (parsedData.alert.includes("False Alarm")) {
                    falseAlarmSound.loop = true;
                    falseAlarmSound.play().catch(error => console.error("üîä Error playing false alarm sound:", error));
                    alertMessage.innerText = `‚ö†Ô∏è False Alarm - ${parsedData.sender} ${parsedData.alert}`;
                } else {
                    alertSound.loop = true;
                    alertSound.play().catch(error => console.error("üîä Error playing emergency sound:", error));
                    alertMessage.innerText = `üö® Emergency Alert - ${parsedData.sender} ${parsedData.alert}`;
                }

                alertModal.style.display = "block";

                if (logContainer) {
                    const logEntry = document.createElement("div");
                    logEntry.classList.add("log-entry");
                    logEntry.innerText = `üïí ${new Date().toLocaleTimeString()} - üö® ${parsedData.sender} ${parsedData.alert}`;
                    logContainer.appendChild(logEntry);
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            } catch (error) {
                console.error("‚ùå Error processing WebSocket message:", error);
            }
        };

        function closeModal() {
            alertModal.style.display = "none";
            alertSound.pause();
            alertSound.currentTime = 0;
            falseAlarmSound.pause();
            falseAlarmSound.currentTime = 0;

            // Send automatic reply back to sender
            if (currentSender) {
                const replyMessage = {
                    recipient: currentSender,
                    response: "This is the Barangay Balidbid Emergency Response Team. We have received your emergency alert and have dispatched assistance to your location. Help is on the way and will arrive shortly. Please stay safe and, if possible, remain in a secure area until our team arrives."
                };
                socket.send(JSON.stringify(replyMessage));
                console.log("‚úÖ Reply sent:", replyMessage);
            } else {
                console.warn("‚ö†Ô∏è No sender information available to send a reply.");
            }
        }

        function logout() {
            sessionStorage.removeItem("loggedIn");
            window.location.href = "login.html";
        }
    </script>
</body>
</html>
